"use strict";angular.module("wxz-ng-img-viewer",[]).provider("wxzNgImageViewer",[function(){this.$get=[function(){function e(e){e.style.msTransform="matrix("+x.scale+", 0, 0,"+x.scale+","+x.x+","+x.y+")",e.style.msTransform="matrix3d("+x.scale+", 0, 0, 0, 0,"+x.scale+", 0, 0, 0, 0, 1, 0,"+x.x+","+x.y+", 0, 1)",e.style.webkitTransform="matrix3d("+x.scale+", 0, 0, 0, 0,"+x.scale+", 0, 0, 0, 0, 1, 0,"+x.x+","+x.y+", 0, 1)",e.style.transform="matrix3d("+x.scale+", 0, 0, 0, 0,"+x.scale+", 0, 0, 0, 0, 1, 0,"+x.x+","+x.y+", 0, 1)"}function t(e,t,n,a){var i,r,l={top:0,left:0,width:n,height:a};return(n>e||a>t)&&(i=n/e,r=a/t,i>r?(l.width=e,l.height=Math.round(a/i)):(l.width=Math.round(n/r),l.height=t)),l.left=Math.round((e-l.width)/2),l.top=Math.round((t-l.height)/2),l}function n(n){var a,i,r=h.getBoundingClientRect(),l=r.width,o=r.height,s=t(l,o,c.width,c.height);c.style.left=(l-n*s.width)/2+"px",c.style.top=(o-n*s.height)/2+"px",c.style.width=n*s.width+"px",c.style.height=n*s.height+"px",x={x:0,y:0,scale:1},x.scale=parseFloat(1/n),a=n*s.width*x.scale,i=n*s.height*x.scale,e(c)}function a(t){t.touches?(p.x=t.changedTouches[0].clientX,p.y=t.changedTouches[0].clientY):(p.x=t.clientX,p.y=t.clientY);var n=p.x-w.x,a=p.y-w.y;x.x+=n,x.y+=a,e(c)}function i(e){e.preventDefault(),e.touches?(w.x=e.changedTouches[0].clientX,w.y=e.changedTouches[0].clientY):(w.x=e.clientX,w.y=e.clientY),m=!0}function r(e){m&&(a(e),w.x=p.x,w.y=p.y)}function l(e){a(e),m=!1}function o(t,n,a,i,r){var l,o=0;t.preventDefault(),t.wheelDelta?o=t.wheelDelta>0?"up":"down":t.detail&&(o=t.detail>0?"down":"up"),l="up"===o?parseFloat(x.scale+i):"down"===o?parseFloat(x.scale-i):null,x.scale=l>n?n:a>l?a:l,e(c),s(r,x.scale)}function s(e,t){u.innerHTML="大小: "+Math.round(e*t*100)+" %"}var h,c,u,d,g=!1,m=!1,w={x:"",y:""},p={x:"",y:""},f={repeat:1,max:5,min:.1,step:.1},x={x:0,y:0,scale:1},v=function(e){this.options="undefined"==typeof e?f:e};return v.prototype={constructor:v,setImg:function(e){var t,a,i=this,r=i.options,l=i.options.repeat||f.repeat,o=8e3,s=0,m=e.width,x=e.height;for(h=r.cont,c=h.querySelector(".wxz-img-view-canvas"),d=c.getContext("2d"),u=h.querySelector(".wxz-scale-value"),g=!0,c.width=m*l,c.height=x*l,c.width>o&&(s=c.width,c.width=o,c.height=Math.round(c.height*(o/s)),m=Math.round(c.width/l),x=Math.round(c.height/l)),c.height>o&&(s=c.height,c.height=o,c.width=Math.round(c.height*(o/s)),m=Math.round(c.width/l),x=Math.round(c.height/l)),t=0;l>t;t++)for(a=0;l>a;a++)d.drawImage(e,a*m,t*x,m,x);w={x:"",y:""},p={x:"",y:""},angular.element(u).removeClass("out"),angular.element(u).addClass("in"),n(l),i.bind()},bind:function(){var e=this,t=+e.options.repeat||f.repeat,n=(+e.options.max||+f.max)/t,a=(+e.options.min||+f.min)/t,c=(+e.options.step||+f.step)/t;h.addEventListener("mousedown",i),h.addEventListener("mousemove",r),h.addEventListener("mouseup",l),h.addEventListener("DOMMouseScroll",function(e){o(e,n,a,c,t)}),h.addEventListener("mousewheel",function(e){o(e,n,a,c,t)}),s(t,x.scale)}},{init:function(e){return new v(e)}}}]}]).directive("wxzNgImageViewer",["wxzNgImageViewer",function(e){return{templateUrl:"../src/template.html",restrict:"EA",transclude:!0,replace:!0,scope:{},link:function(t,n,a){var i={repeat:null,max:null,min:null,cont:n[0]};angular.isUndefined(a.max)||(i.max=+a.max),angular.isUndefined(a.min)||(i.min=+a.min),angular.isUndefined(a.defalutValue)||(i.defalutValue=+a.defalutValue),angular.isUndefined(a.repeat)||(i.repeat=+a.repeat);var r=e.init(i);t.$parent.$watch(a.imgSrc,function(e){if(!angular.isUndefined(e)){var t=new Image;t.src=e,t.onload=function(){r.setImg(t)}}})}}}]),angular.module("wxz-ng-image-viewer").run(["$templateCache",function(e){e.put("../src/template.html",'<div class=wxz-img-view-cont><canvas class=wxz-img-view-canvas></canvas><div class="wxz-scale-value fade out"></div></div>')}]);