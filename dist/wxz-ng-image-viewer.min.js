"use strict";angular.module("wxz-ng-img-viewer",[]).provider("wxzNgImageViewer",[function(){this.$get=[function(){function e(e){e.style.msTransform="matrix("+x.scale+", 0, 0,"+x.scale+","+x.x+","+x.y+")",e.style.msTransform="matrix3d("+x.scale+", 0, 0, 0, 0,"+x.scale+", 0, 0, 0, 0, 1, 0,"+x.x+","+x.y+", 0, 1)",e.style.webkitTransform="matrix3d("+x.scale+", 0, 0, 0, 0,"+x.scale+", 0, 0, 0, 0, 1, 0,"+x.x+","+x.y+", 0, 1)",e.style.transform="matrix3d("+x.scale+", 0, 0, 0, 0,"+x.scale+", 0, 0, 0, 0, 1, 0,"+x.x+","+x.y+", 0, 1)"}function t(e,t,n,i){var a,r,o={top:0,left:0,width:n,height:i};return(n>e||i>t)&&(a=n/e,r=i/t,a>r?(o.width=e,o.height=Math.round(i/a)):(o.width=Math.round(n/r),o.height=t)),o.left=Math.round((e-o.width)/2),o.top=Math.round((t-o.height)/2),o}function n(n){var i,a,r=s.getBoundingClientRect(),o=r.width,l=r.height,h=t(o,l,u.width,u.height);u.style.left=(o-n*h.width)/2+"px",u.style.top=(l-n*h.height)/2+"px",u.style.width=n*h.width+"px",u.style.height=n*h.height+"px",x={x:0,y:0,scale:1},x.scale=parseFloat(1/n),i=n*h.width*x.scale,a=n*h.height*x.scale,e(u)}function i(t){t.touches?(f.x=t.changedTouches[0].clientX,f.y=t.changedTouches[0].clientY):(f.x=t.clientX,f.y=t.clientY);var n=f.x-p.x,i=f.y-p.y;x.x+=n,x.y+=i,e(u)}function a(e){e.preventDefault(),e.touches?(p.x=e.changedTouches[0].clientX,p.y=e.changedTouches[0].clientY):(p.x=e.clientX,p.y=e.clientY),m=!0}function r(e){m&&(i(e),p.x=f.x,p.y=f.y)}function o(e){i(e),m=!1}function l(t,n,i,a,r){var o,l=0;t.preventDefault(),t.wheelDelta?l=t.wheelDelta>0?"up":"down":t.detail&&(l=t.detail>0?"down":"up"),o="up"===l?parseFloat(x.scale+a):"down"===l?parseFloat(x.scale-a):null,x.scale=o>n?n:i>o?i:o,e(u),h(r,x.scale)}function h(e,t){d.innerHTML="大小: "+Math.round(e*t*100)+" %"}var s,u,d,c,g=!1,m=!1,p={x:"",y:""},f={x:"",y:""},w={repeat:1,max:5,min:.1,step:.1},x={x:0,y:0,scale:1},y=function(e){this.options="undefined"==typeof e?w:e};return y.prototype={constructor:y,setImg:function(e){var t,i,a=this,r=a.options,o=a.options.repeat||w.repeat,l=8e3,h=0,m=e.width,x=e.height;for(s=r.cont,u=s.querySelector(".wxz-img-view-canvas"),c=u.getContext("2d"),d=s.querySelector(".wxz-scale-value"),g=!0,u.width=m*o,u.height=x*o,u.width>l&&(h=u.width,u.width=l,u.height=Math.round(u.height*(l/h)),m=Math.round(u.width/o),x=Math.round(u.height/o)),u.height>l&&(h=u.height,u.height=l,u.width=Math.round(u.height*(l/h)),m=Math.round(u.width/o),x=Math.round(u.height/o)),t=0;o>t;t++)for(i=0;o>i;i++)c.drawImage(e,i*m,t*x,m,x);p={x:"",y:""},f={x:"",y:""},angular.element(d).removeClass("out"),angular.element(d).addClass("in"),n(o),a.bind()},bind:function(){var e=this,t=+e.options.repeat||w.repeat,n=(+e.options.max||+w.max)/t,i=(+e.options.min||+w.min)/t,u=(+e.options.step||+w.step)/t;s.addEventListener("mousedown",a),s.addEventListener("mousemove",r),s.addEventListener("mouseup",o),s.addEventListener("DOMMouseScroll",function(e){l(e,n,i,u,t)}),s.addEventListener("mousewheel",function(e){l(e,n,i,u,t)}),h(t,x.scale)}},{init:function(e){return new y(e)}}}]}]).directive("wxzNgImageViewer",["wxzNgImageViewer",function(e){return{templateUrl:"../src/template.html",restrict:"EA",transclude:!0,replace:!0,scope:{},link:function(t,n,i){var a={repeat:null,max:null,min:null,cont:n[0]};angular.isUndefined(i.max)||(a.max=+i.max),angular.isUndefined(i.min)||(a.min=+i.min),angular.isUndefined(i.defalutValue)||(a.defalutValue=+i.defalutValue),angular.isUndefined(i.repeat)||(a.repeat=+i.repeat);var r=e.init(a);t.$parent.$watch(i.imgSrc,function(e){if(!angular.isUndefined(e)){var t=new Image;t.src=e,t.onload=function(){r.setImg(t)}}})}}}]);